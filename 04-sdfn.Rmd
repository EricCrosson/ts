# dsfk

## Autoregressive Moving Average Models `r emo::ji("warning")`

```{r, echo = FALSE}
library(simts)
library(rdatamarket)
```

```{definition, label="defARMA", name="ARMA models"}
A process $(X_{t})$ is an ARMA($p$,$q$) process if $(X_t)$ (or $(X_{t}-\mathbb{E}[X_{t}])$) satisfies the linear difference equation
		\[X_{t} = \phi_{1}X_{t-1} + \cdots + \phi_{p}X_{t-p} + W_{t}+\theta_{1}W_{t-1}+ \cdots+\theta_{q}W_{t-q},\]
		where $W_{t}\sim \mathcal{N}(0,\sigma_{w}^2)$. 
		An ARMA($p$,$q$) can be written in concise form as:
				$\phi \left( B \right) 
		\[X_t = \theta \left( B \right)W_t, \]
	where $\phi(z)$ and $\theta(z)$ are AR and MA polynomials:
	\[\phi(z)=1-\phi_{1}z-\cdots-\phi_{p}z^p \]
	\[\theta(z)=1+\theta_{1}z+\cdots+\theta_{q}z^q. \]
```
<br>

With this in mind, several remarks can be made:

- Assume $\mathbb{E}(X_{t})=\mu = 0$. Otherwise you must substitute $X_{t} - \mu$ for $X_{t}$.
- If $p=0$, then ARMA$(p=0,q)=$ MA$(q)$ process.
- If $q=0$, then ARMA$(p,q=0)=$ AR$(p)$ process.
- We mainly work with ARMA models that are causal and invertible.
    - An ARMA model is causal and invertible if its AR part is causal and its MA part is invertible. 
    - AR$(p)$ models are always **invertible** and MA$(q)$ models are always **causal**.
- Forecasting with ARMA process relies on the same techniques used with MA process.

<br>

ARMA models can have redundante parameters. This is illustrated in the following examples:

```{example, name="Parameter Redundancy of ARMA models", label = "redunARMA"}
Let us consider the process:
		\begin{align*}
			X_t &= W_t \\
			X_t - 0.9 X_{t-1} &= W_t - 0.9 W_{t-1}\\
			X_t &= 0.9 X_{t-1} + W_t - 0.9 W_{t-1}.
		\end{align*}
		Therefore, $X_t = W_t$ can be written as $X_t = 0.9 X_{t-1} + W_t - 0.9 W_{t-1}$, which looks a lot like an ARMA(1,1). To assess the parameter redundancy of this ARMA models, it is useful to express the models in operator form, in this case:
		\begin{equation*}
			X_t = 0.9 X_{t-1} + W_t - 0.9 W_t \Longleftrightarrow (1 - 0.9B) X_t = (1 - 0.9 B) W_t.
		\end{equation*}
		It clearly appears that $(1 - 0.9B)$ can be simplified in the above equation yielding to our original model $X_t = W_t$. In general, if a model has autoregressive and moving average operators that share a common root then the model has **redundant parameters**. 
```
<br>

```{example, name="Parameter Redundancy of ARMA models", label = "redunARMA2"}
		Consider the following example:
		\begin{equation*}
			X_t = 0.3 X_{t-1} + 0.1 X_{t-2} + W_t + W_{t-1} + 0.16 W_{t-2},
 		\end{equation*}
		which is an ARMA(2,2). By rearranging the terms, we obtain
		\begin{equation*}
			\begin{aligned} 
				X_t &= 0.3 X_{t-1} + 0.1 X_{t-2} + W_t + W_{t-1} + 0.16 W_{t-2}\\
				 X_t - 0.3 X_{t-1} - 0.1 X_{t-2} &= W_t + W_{t-1} + 0.16 W_{t-2}\\
				 (1 - 0.3 B - 0.1 B^2 ) X_t  &= (1 + B + 0.16B^2) W_t\\
				 (1 + 0.2B)(1 - 0.5 B) X_t  &= (1 + 0.2B)(1 + 0.8 B) W_t\\
				(1 - 0.5 B) X_t  &= (1 + 0.8 B) W_t\\
				 X_t  &= 0.5 X_{t-1} + W_t - 0.8 W_{t-1}.
			\end{aligned}
		\end{equation*}
		Therefore, our initial model is in fact an **ARMA(1,1)**. Note that this model is causal (as $|\phi|<1$) and invertible (as $|\theta| < 1$).
```

### ACF/PACF

- Derivation the ACF/PACF of ARMA($p$,$q$) is generally difficult. \textbf{Example}: Given an ARMA(1,1), we have $\rho(h) = \phi^{h-1} \rho(1)$ where
			
\begin{equation*}
				\rho(1) = \frac{\left(1+\theta \phi \right)\left(\theta + \phi\right)}{1+2\phi\theta+\theta^2}.
\end{equation*}
			
- It is difficult to identify ARMA process from their ACF/PACF. Indeed, we have:

Table: (\#acfpacf) Caption here

-------------------------------------------------------------
                  AR($p$)         MA($q$)       ARMA($p$,$q$)
------------- --------------- --------------- --------------- 
    ACF         Tails off     Cuts off after      Tails off
                                  lag $q$
                                  
   PACF       Cuts off after    Tails off         Tails off
                 lag $p$
-------------------------------------------------------------


As an example let us consider the following two ARMA($q$) models:

$$
\begin{aligned}
X_t &= 0.3 X_{t-1} - 0.8 X_{t-2} +  0.7 W_{t-1} + W_t \\
Y_t &= 1.2 X_{t-1} - 0.25 X_{t-2} - 0.1 W_{t-1} - 0.75 W_{t-2} + W_t, \\
\end{aligned}
$$

where $W_t \overset{iid}{\sim} \mathcal{N}(0, 1)$

```{r, cache = FALSE, fig.cap="TO DO", fig.asp = 1, fig.width = 8, fig.align='center'}
Xt = gen_gts(n = 500, ARMA(ar = c(0.3,-0.8), ma = 0.7, sigma2 = 1))
Yt = gen_gts(n = 500, ARMA(ar = c(1.2, -0.25), 
             ma = c(-0.1, -0.75), sigma2 = 1))
par(mfrow = c(2,1))
plot(Xt, main = expression("Simulated process: "* X[t] *" with "* T *" = 500"))
plot(Yt, main = expression("Simulated process: "* Y[t] *" with "* T *" = 500"))
```

The theoretical ACF/PACF

```{r, fig.asp = 0.45, fig.width = 8, fig.align='center', fig.cap="TO DO"}
par(mfrow = c(1,2))
plot(theo_acf(ar = c(0.3,-0.8), ma = 0.7), main = expression("Theo. ACF - MA(1); "* theta *" = 0.9"))
plot(theo_pacf(ar = c(0.3,-0.8), ma = 0.7), main = expression("Theo. PACF - MA(1); "* theta *" = 0.9"))
```

```{r, fig.asp = 0.45, fig.width = 8, fig.align='center', fig.cap="TO DO"}
par(mfrow = c(1,2))
plot(theo_acf(ar = c(1.2, -0.25), ma = c(-0.1, -0.75)), main = expression("Theo. ACF - MA(1); "* theta *" = 0.9"))
plot(theo_pacf(ar = c(1.2, -0.25), ma = c(-0.1, -0.75)), main = expression("Theo. ACF - MA(1); "* theta *" = -0.9"))
```

Remark on the identification of the order of an ARMA model:

- ACF and PACF of ARMA models are difficult to interpret.
- It is generally easier to consider a list of candidate models and selected the ``best'' model in this list using a model selection criterion or an estimator of the prediction error (e.g. MAPE).
- Check diagnostic plot to assess if the model is reasonable for this time series.


```{r, fig.asp = 0.6, fig.width = 7, fig.align='center', fig.cap="TO DO", cache = TRUE}
Xt = gts(as.numeric(dmseries("https://datamarket.com/data/set/22y1/annual-copper-prices-1800-1997#!ds=22y1&display=line")),
    start = 1921, freq = 12, name_ts = "Copper prices (minus the long-term trend)",
    data_name = "Copper Price", name_time = "")
plot(Xt)
```

```{r, fig.asp = 0.45, fig.width = 8, fig.align='center', fig.cap="Empirical ACF (left) and PACF (right) of the Copper time series data."}
corr_analysis(Xt)
```

```{r, fig.asp = 1.45, fig.width = 8, fig.align='center', fig.cap="Empirical ACF (left) and PACF (right) of the Copper time series data."}
select(ARMA(4,5), Xt)
```

To decide:

```{r, eval = FALSE}
evaluate(list(AR(1), ARMA(3,2), ARMA(3, 5)), Xt, criterion = "MAPE", start = 0.5)
```

```{r, eval = TRUE, cache = TRUE, fig.asp = 0.73, fig.width = 7, fig.align='center', fig.cap="Diagnostic plots for the residuals of a TO DO"}
model_copper = estimate(ARMA(3,2), Xt)
check(model_copper)
```

## ARIMA

## SARIMA

### Real data example

```{r, fig.asp = 0.6, fig.width = 7, fig.align='center', fig.cap="TO DO", cache = TRUE}
Xt = gts(as.numeric(dmseries("https://datamarket.com/data/set/22pw/monthly-lake-erie-levels-1921-1970#!ds=22pw&display=line")),
    start = 1921, freq = 12, name_ts = "Water Levels",
    data_name = "Monthly Lake Erie Levels", name_time = "")
plot(Xt)
```

```{r, fig.asp = 0.45, fig.width = 8, fig.align='center', fig.cap="Empirical ACF (left) and PACF (right) of the Lake Erie time series data."}
corr_analysis(Xt)
```



